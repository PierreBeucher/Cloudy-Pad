version: '3'

vars:
  NIX_CONFIG_DIR: provision
  WOLF_CONFIG_DIR: wolf
  
tasks:
  quickstart:
    cmd: scripts/quickstart.sh
  # 
  # Pulumi
  # 

  preview:
    cmds:
      - pulumi -C infra preview

  infra:
    cmds:
      - pulumi -C infra up -yfr

  refresh:
    cmds:
      - pulumi -C infra refresh -y
  
  destroy:
    prompt: This will destroy all resources and disk data. Make sure to make a backup or sync your saved games. Continue?
    cmds:
      - pulumi -C infra destroy -ryf
  
  output:
    cmds:
      - pulumi -C infra stack output -j
  
  select:
    cmds:
      - pulumi -C infra stack select

  cancel:
    cmds:
      - pulumi -C infra cancel -y

  #
  # Instance management
  #

  reboot: 
    # Use anchor as Task will always try to get variables 
    # even though stack does not exists yet
    # Place it here instead of top-level .vars element or such to avoid syntax complaints
    vars: &vars
      SUNSHINE_HOST: 
        sh: pulumi -C infra stack output -j | jq .ipAddress -r
      AWS_REGION: 
        sh: pulumi -C infra stack output awsRegion
      AWS_EC2_INSTANCE_ID: 
        sh: pulumi -C infra stack output ec2InstanceId
      SUNSHINE_URL: 
        sh: pulumi -C infra stack output sunshineUrl
    cmd: ssh -i .ssh/key root@{{.SUNSHINE_HOST}} reboot
    ignore_error: true # reboot closes SSH session with non-0

  start: 
    vars: *vars
    cmd: >-
      aws --region {{.AWS_REGION}}
      ec2 start-instances --instance-ids {{.AWS_EC2_INSTANCE_ID}}
    
  stop: 
    vars: *vars
    cmd: >-
      aws --region {{.AWS_REGION}}
      ec2 stop-instances --instance-ids {{.AWS_EC2_INSTANCE_ID}}

  nix-config:
    vars: *vars
    cmds:
      - scp -i .ssh/key -rp {{.NIX_CONFIG_DIR}}/configuration.nix root@{{.SUNSHINE_HOST}}:/etc/nixos/configuration.nix
      - scp -i .ssh/key -rp {{.NIX_CONFIG_DIR}}/modules root@{{.SUNSHINE_HOST}}:/etc/nixos
      - ssh -i .ssh/key root@{{.SUNSHINE_HOST}} nixos-rebuild switch
  
  wait-ssh:
    vars: *vars
    cmd: |-
      while ! ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i .ssh/key root@{{.SUNSHINE_HOST}} exit; do
          echo "Waiting for SSH on {{.SUNSHINE_HOST}}..."
          sleep 10
      done
      echo "{{.SUNSHINE_HOST}} reached via SSH"

  ssh:
    vars: *vars
    cmd: ssh -i .ssh/key root@{{.SUNSHINE_HOST}}
    interactive: true

  ssh-tunnel:
    vars: *vars
    cmd: ssh -i .ssh/key -L localhost:47990:localhost:47990 root@{{.SUNSHINE_HOST}}

  sunshine-browser:
    vars: *vars
    cmd: xdg-open https://localhost:47990

  wolf-nvidia:
    vars: *vars
    cmds:
    - scp -i .ssh/key -rp {{.WOLF_CONFIG_DIR}}/* root@{{.SUNSHINE_HOST}}:/root/wolf/
    - ssh -i .ssh/key root@{{.SUNSHINE_HOST}} /root/wolf/docker-nvidia-start.sh